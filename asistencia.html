<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia - Soporte Plataforma</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="asistencia.css">
</head>

<body>
    <div class="app-container">
        <!-- Mobile Overlay & Button -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>
        <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

        <!-- Global Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="asistencia.html" class="sidebar-logo">
                    <span>üìã</span> Asistencia
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-link">
                    <span class="sidebar-icon">‚òï</span> Cafeter√≠a
                </a>
                <a href="soporte.html" class="sidebar-link">
                    <span class="sidebar-icon">üõ†Ô∏è</span> Soporte
                </a>
                <a href="asistencia.html" class="sidebar-link active">
                    <span class="sidebar-icon">üìã</span> Asistencia
                </a>
                <a href="videos.html" class="sidebar-link">
                    <span class="sidebar-icon">üé•</span> Videos
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="sidebarAvatar">AD</div>
                    <div class="user-info">
                        <span class="user-name" id="sidebarUserName">Admin</span>
                        <span class="user-role" id="sidebarUserRole">Administrador</span>
                    </div>
                </div>
                <button onclick="logout()" class="btn-logout">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="main">
                <div class="container">
                    <!-- T√≠tulo Principal -->
                    <div class="asistencia-header">
                        <div class="header-icon">üìã</div>
                        <h1 class="section-title">Control de Asistencia</h1>
                        <p class="section-subtitle" id="nombreSesion">Cargando...</p>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs-container">
                        <button class="tab-btn active" data-tab="registro" onclick="cambiarTab('registro')">
                            ‚úçÔ∏è Registro
                        </button>
                        <button class="tab-btn" data-tab="admin" onclick="cambiarTab('admin')">
                            ‚öôÔ∏è Administraci√≥n
                        </button>
                    </div>

                    <!-- TAB: REGISTRO DE ASISTENCIA -->
                    <div id="tabRegistro" class="tab-content active">
                        <div class="registro-card">
                            <div class="info-banner">
                                <span class="info-icon">üõ°Ô∏è</span>
                                <span>Ingresa tu correo y confirma tu turno actual.</span>
                            </div>

                            <!-- Selector de Turno -->
                            <div class="form-section">
                                <label class="form-label">1. ¬øEn qu√© turno asististe?</label>
                                <div class="turno-selector">
                                    <button type="button" class="turno-btn active" data-turno="matutino"
                                        onclick="seleccionarTurno('matutino')">
                                        <span class="turno-icon">‚òÄÔ∏è</span>
                                        <span class="turno-text">Matutino</span>
                                    </button>
                                    <button type="button" class="turno-btn" data-turno="vespertino"
                                        onclick="seleccionarTurno('vespertino')">
                                        <span class="turno-icon">üåô</span>
                                        <span class="turno-text">Vespertino</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Correo -->
                            <div class="form-section">
                                <label class="form-label">2. Correo Electr√≥nico</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üë§</span>
                                    <input type="email" id="inputCorreo" class="form-input-large"
                                        placeholder="correo@ejemplo.com">
                                </div>
                            </div>

                            <!-- Mensaje de Error/√âxito -->
                            <div id="mensajeRegistro" class="mensaje-registro hidden"></div>

                            <!-- Bot√≥n de Registro -->
                            <button id="btnMarcarAsistencia" class="btn-asistencia" onclick="marcarAsistencia()">
                                MARCAR ASISTENCIA
                            </button>
                        </div>
                    </div>

                    <!-- TAB: ADMINISTRACI√ìN -->
                    <div id="tabAdmin" class="tab-content">
                        <!-- Sub-tabs de Admin -->
                        <div class="admin-subtabs">
                            <button class="subtab-btn active" data-subtab="lista" onclick="cambiarSubtab('lista')">
                                üìã Lista del D√≠a
                            </button>
                            <button class="subtab-btn" data-subtab="estadisticas"
                                onclick="cambiarSubtab('estadisticas')">
                                üìä Estad√≠sticas
                            </button>
                            <button class="subtab-btn" data-subtab="alumnos" onclick="cambiarSubtab('alumnos')">
                                üë• Alumnos
                            </button>
                            <button class="subtab-btn" data-subtab="config" onclick="cambiarSubtab('config')">
                                ‚öôÔ∏è Config
                            </button>
                        </div>

                        <!-- SUBTAB: Lista del D√≠a -->
                        <div id="subtabLista" class="subtab-content active">
                            <div class="admin-card">
                                <div class="card-header">
                                    <div>
                                        <h3>üìã Registro de Asistencia <span id="fechaMostrada"
                                                style="font-size: 0.8em; color: #666;"></span></h3>
                                        <p class="text-muted">Mostrando: <span id="totalHoy">0</span> registros</p>
                                    </div>
                                    <div class="card-actions" style="flex-direction: column; width: 100%; gap: 10px;">
                                        <!-- Fila Superior: T√≠tulo y Totales -->
                                        <div
                                            style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                                            <div style="display: flex; gap: 10px;">
                                                <button class="btn-action btn-success" onclick="exportarExcel()"
                                                    title="Descargar Excel">
                                                    üìä Excel
                                                </button>
                                                <button class="btn-action btn-danger" onclick="exportarPDF()"
                                                    style="background-color: #EF4444; border-color: #EF4444; color: white;"
                                                    title="Descargar PDF">
                                                    üìÑ PDF
                                                </button>
                                                <button class="btn-action" onclick="exportarCSV()"
                                                    style="background-color: #3B82F6; color: white;"
                                                    title="Descargar CSV">
                                                    üì• CSV
                                                </button>
                                                <button id="btnRefrescar" class="btn-action"
                                                    onclick="refrescarTablaManual()"
                                                    style="background-color: var(--color-navy); color: white;"
                                                    title="Actualizar Tabla">
                                                    <span id="iconRefrescar" style="display: inline-block;">üîÑ</span>
                                                    Refrescar
                                                </button>
                                                <button class="btn-action btn-danger" onclick="limpiarRegistros()">
                                                    üóëÔ∏è Limpiar
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Fila Inferior: Filtros -->
                                        <div class="filters-row">
                                            <input type="date" id="filtroFecha" class="filter-select"
                                                onchange="cargarRegistros()">

                                            <select id="filtroTurno" class="filter-select" onchange="filtrarLista()">
                                                <option value="todos">Todos los Turnos</option>
                                                <option value="matutino">‚òÄÔ∏è Matutino</option>
                                                <option value="vespertino">üåô Vespertino</option>
                                            </select>

                                            <div class="search-container-modern">
                                                <span class="search-icon-float">üîç</span>
                                                <input type="text" id="buscadorGeneral" class="search-input-modern"
                                                    placeholder="Buscar por correo o nombre..."
                                                    onkeyup="filtrarLista()">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Hora</th>
                                                <th>Alumno</th>
                                                <th>Turno</th>
                                                <th>Fecha</th>
                                                <th>Turno Asistido</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaRegistros">
                                            <!-- Se llena din√°micamente -->
                                        </tbody>
                                    </table>
                                    <div id="listaVacia" class="empty-state hidden">
                                        <span class="empty-icon">üìÖ</span>
                                        <p>No hay registros de asistencia hoy.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUBTAB: Estad√≠sticas -->
                        <div id="subtabEstadisticas" class="subtab-content">
                            <div class="stats-grid">
                                <div class="stat-card stat-matutino">
                                    <div class="stat-icon">‚òÄÔ∏è</div>
                                    <div class="stat-info">
                                        <h4>Matutino</h4>
                                        <div class="stat-value" id="statMatutino">0</div>
                                        <div class="stat-label">asistencias</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-vespertino">
                                    <div class="stat-icon">üåô</div>
                                    <div class="stat-info">
                                        <h4>Vespertino</h4>
                                        <div class="stat-value" id="statVespertino">0</div>
                                        <div class="stat-label">asistencias</div>
                                    </div>
                                </div>
                                <div class="stat-card stat-total">
                                    <div class="stat-icon">üìä</div>
                                    <div class="stat-info">
                                        <h4>Total</h4>
                                        <div class="stat-value" id="statTotal">0</div>
                                        <div class="stat-label">registros</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stats-actions"
                                style="margin-top: 2rem; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 2rem;">
                                <button class="btn-action btn-danger" onclick="limpiarRegistros()"
                                    style="padding: 10px 20px; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px;">
                                    üóëÔ∏è Limpiar Estad√≠sticas (Reset a 0)
                                </button>
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #6b7280;">
                                    ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Esta acci√≥n eliminar√° permanentemente todas las
                                    asistencias registradas hoy.
                                </p>
                            </div>
                        </div>

                        <!-- SUBTAB: Alumnos -->
                        <div id="subtabAlumnos" class="subtab-content">
                            <div class="admin-card">
                                <div class="card-header">
                                    <h3>üë• Gesti√≥n de Alumnos Autorizados</h3>
                                </div>

                                <!-- Agregar Individual -->
                                <div class="agregar-section">
                                    <h4>‚ûï Agregar Alumno Individual</h4>
                                    <div class="agregar-form">
                                        <input type="email" id="nuevoCorreo" class="form-input"
                                            placeholder="correo@ejemplo.com">
                                        <input type="text" id="nuevoNombre" class="form-input"
                                            placeholder="Nombre (opcional)">
                                        <select id="nuevoTurno" class="form-input">
                                            <option value="matutino">‚òÄÔ∏è Matutino</option>
                                            <option value="vespertino">üåô Vespertino</option>
                                        </select>
                                        <button class="btn-primary" onclick="agregarAlumnoIndividual()">Agregar</button>
                                    </div>
                                </div>

                                <!-- Importar en Lote -->
                                <div class="importar-section">
                                    <h4>üìã Importar Lista (Pegar correos)</h4>
                                    <div class="importar-grid">
                                        <div class="importar-col">
                                            <label class="turno-label matutino">‚òÄÔ∏è Turno Matutino</label>
                                            <textarea id="listaMatutino" class="importar-textarea"
                                                placeholder="Pega los correos aqu√≠ (uno por l√≠nea)"></textarea>
                                        </div>
                                        <div class="importar-col">
                                            <label class="turno-label vespertino">üåô Turno Vespertino</label>
                                            <textarea id="listaVespertino" class="importar-textarea"
                                                placeholder="Pega los correos aqu√≠ (uno por l√≠nea)"></textarea>
                                        </div>
                                    </div>
                                    <div class="importar-actions">
                                        <button class="btn-primary btn-large" onclick="importarListas()">
                                            üíæ Guardar Listas
                                        </button>
                                    </div>
                                </div>

                                <!-- Lista Actual -->
                                <div class="lista-actual">
                                    <h4>üìù Alumnos Registrados</h4>
                                    <div class="alumnos-count">
                                        <span>Matutino: <strong id="countMatutino">0</strong></span>
                                        <span>Vespertino: <strong id="countVespertino">0</strong></span>
                                    </div>
                                    <div class="alumnos-grid"
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <!-- Columna Matutino -->
                                        <div class="columna-turno">
                                            <h5 class="turno-header matutino"
                                                style="color: #B45309; padding: 10px; background: #FEF3C7; border-radius: 8px 8px 0 0; margin: 0; text-align: center; font-weight: 600;">
                                                ‚òÄÔ∏è Matutino</h5>
                                            <div id="listaAlumnosMatutino" class="alumnos-list"
                                                style="border-top: none; border-radius: 0 0 8px 8px; max-height: 400px;">
                                                <!-- Lista Matutino -->
                                            </div>
                                        </div>

                                        <!-- Columna Vespertino -->
                                        <div class="columna-turno">
                                            <h5 class="turno-header vespertino"
                                                style="color: #4338CA; padding: 10px; background: #E0E7FF; border-radius: 8px 8px 0 0; margin: 0; text-align: center; font-weight: 600;">
                                                üåô Vespertino</h5>
                                            <div id="listaAlumnosVespertino" class="alumnos-list"
                                                style="border-top: none; border-radius: 0 0 8px 8px; max-height: 400px;">
                                                <!-- Lista Vespertino -->
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Contenedor antiguo eliminado para evitar conflictos -->
                                    <div id="listaAlumnos" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- SUBTAB: Configuraci√≥n -->
                        <div id="subtabConfig" class="subtab-content">
                            <div class="admin-card">
                                <div class="card-header">
                                    <h3>‚öôÔ∏è Configuraci√≥n del Portal</h3>
                                </div>
                                <div class="config-form">
                                    <div class="form-group">
                                        <label class="form-label">Nombre de la Sesi√≥n / Clase</label>
                                        <input type="text" id="configNombre" class="form-input"
                                            placeholder="Ej: Biolog√≠a Celular">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">URL Script (Google Sheets)</label>
                                        <input type="text" id="configScript" class="form-input form-input-mono"
                                            placeholder="https://script.google.com/...">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Enlace para Alumnos (Solo Registro)</label>
                                        <div class="input-group" style="display: flex; gap: 10px;">
                                            <input type="text" id="linkAlumno" class="form-input" readonly
                                                value="Cargando...">
                                            <button class="btn-action" onclick="copiarEnlaceAlumno()"
                                                title="Copiar al portapapeles">
                                                üìã Copiar
                                            </button>
                                        </div>
                                        <p class="help-text"
                                            style="font-size: 0.85rem; color: #6b7280; margin-top: 5px;">
                                            Comparte este enlace con los alumnos para que registren su asistencia.
                                        </p>
                                    </div>

                                    <div class="form-actions">
                                        <button class="btn-primary" onclick="guardarConfiguracion()">
                                            üíæ Guardar Cambios
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Export Tools -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="auth-config.js"></script>
    <script>protectPage();</script>
    <script src="asistencia.js"></script>
</body>

</html>